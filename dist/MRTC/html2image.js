!function(global){"use strict";var util={escape:function(string){return string.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")},parseExtension:parseExtension,mimeType:function(extension){extension=parseExtension(extension).toLowerCase();return function(){var WOFF="application/font-woff";return{woff:WOFF,woff2:WOFF,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}()[extension]||""},dataAsUrl:function(content,type){return"data:"+type+";base64,"+content},isDataUrl:function(url){return-1!==url.search(/^(data:)/)},canvasToBlob:function(canvas){return canvas.toBlob?new Promise(function(resolve){canvas.toBlob(resolve)}):function(canvas){return new Promise(function(resolve){for(var binaryString=window.atob(canvas.toDataURL().split(",")[1]),length=binaryString.length,binaryArray=new Uint8Array(length),i=0;i<length;i++)binaryArray[i]=binaryString.charCodeAt(i);resolve(new Blob([binaryArray],{type:"image/png"}))})}(canvas)},resolveUrl:function(url,baseUrl){var doc=document.implementation.createHTMLDocument(),base=doc.createElement("base");doc.head.appendChild(base);var a=doc.createElement("a");return doc.body.appendChild(a),base.href=baseUrl,a.href=url,a.href},getAndEncode:function(url){domtoimage.impl.options.cacheBust&&(url+=(/\?/.test(url)?"&":"?")+(new Date).getTime());return new Promise(function(resolve){var placeholder,split,request=new XMLHttpRequest;function fail(message){console.error(message),resolve("")}request.onreadystatechange=function(){if(4!==request.readyState)return;if(200!==request.status)return void(placeholder?resolve(placeholder):fail("cannot fetch resource: "+url+", status: "+request.status));var encoder=new FileReader;encoder.onloadend=function(){var content=encoder.result.split(/,/)[1];resolve(content)},encoder.readAsDataURL(request.response)},request.ontimeout=function(){placeholder?resolve(placeholder):fail("timeout of 30000ms occured while fetching resource: "+url)},request.responseType="blob",request.timeout=3e4,request.open("GET",url,!0),request.send(),!domtoimage.impl.options.imagePlaceholder||(split=domtoimage.impl.options.imagePlaceholder.split(/,/))&&split[1]&&(placeholder=split[1])})},uid:function(){var index=0;return function(){return"u"+("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)+index++}}(),delay:function(ms){return function(arg){return new Promise(function(resolve){setTimeout(function(){resolve(arg)},ms)})}},asArray:function(arrayLike){for(var array=[],length=arrayLike.length,i=0;i<length;i++)array.push(arrayLike[i]);return array},escapeXhtml:function(string){return string.replace(/#/g,"%23").replace(/\n/g,"%0A")},makeImage:function(uri){return new Promise(function(resolve,reject){var image=new Image;image.onload=function(){resolve(image)},image.onerror=reject,image.src=uri})},width:function(node){var leftBorder=px(node,"border-left-width"),rightBorder=px(node,"border-right-width");return node.scrollWidth+leftBorder+rightBorder},height:function(node){var topBorder=px(node,"border-top-width"),bottomBorder=px(node,"border-bottom-width");return node.scrollHeight+topBorder+bottomBorder}};function parseExtension(match){match=/\.([^\.\/]*?)$/g.exec(match);return match?match[1]:""}function px(node,value){value=window.getComputedStyle(node).getPropertyValue(value);return parseFloat(value.replace("px",""))}var URL_REGEX,inliner={inlineAll:function(string,baseUrl,get){return shouldProcess(string)?Promise.resolve(string).then(readUrls).then(function(urls){var done=Promise.resolve(string);return urls.forEach(function(url){done=done.then(function(string){return inline(string,url,baseUrl,get)})}),done}):Promise.resolve(string)},shouldProcess:shouldProcess,impl:{readUrls:readUrls,inline:inline}};function shouldProcess(string){return-1!==string.search(URL_REGEX)}function readUrls(string){for(var match,result=[];null!==(match=URL_REGEX.exec(string));)result.push(match[1]);return result.filter(function(url){return!util.isDataUrl(url)})}function inline(string,url,baseUrl,get){return Promise.resolve(url).then(function(url){return baseUrl?util.resolveUrl(url,baseUrl):url}).then(get||util.getAndEncode).then(function(data){return util.dataAsUrl(data,util.mimeType(url))}).then(function(dataUrl){return string.replace(function(url){return new RegExp("(url\\(['\"]?)("+util.escape(url)+")(['\"]?\\))","g")}(url),"$1"+dataUrl+"$3")})}var fontFaces={resolveAll:function(){return readAll(document).then(function(webFonts){return Promise.all(webFonts.map(function(webFont){return webFont.resolve()}))}).then(function(cssStrings){return cssStrings.join("\n")})},impl:{readAll:readAll}};function readAll(){return Promise.resolve(util.asArray(document.styleSheets)).then(function(styleSheets){var cssRules=[];return styleSheets.forEach(function(sheet){try{util.asArray(sheet.cssRules||[]).forEach(cssRules.push.bind(cssRules))}catch(e){console.log("Error while reading CSS rules from "+sheet.href,e.toString())}}),cssRules}).then(function(cssRules){return cssRules.filter(function(rule){return rule.type===CSSRule.FONT_FACE_RULE}).filter(function(rule){return inliner.shouldProcess(rule.style.getPropertyValue("src"))})}).then(function(rules){return rules.map(newWebFont)});function newWebFont(webFontRule){return{resolve:function(){var baseUrl=(webFontRule.parentStyleSheet||{}).href;return inliner.inlineAll(webFontRule.cssText,baseUrl)},src:function(){return webFontRule.style.getPropertyValue("src")}}}}var images={inlineAll:function inlineAll(node){if(!(node instanceof Element))return Promise.resolve(node);return inlineBackground(node).then(function(){return node instanceof HTMLImageElement?newImage(node).inline():Promise.all(util.asArray(node.childNodes).map(function(child){return inlineAll(child)}))});function inlineBackground(node){var background=node.style.getPropertyValue("background");return background?inliner.inlineAll(background).then(function(inlined){node.style.setProperty("background",inlined,node.style.getPropertyPriority("background"))}).then(function(){return node}):Promise.resolve(node)}},impl:{newImage:newImage}};function newImage(element){return{inline:function(get){return util.isDataUrl(element.src)?Promise.resolve():Promise.resolve(element.src).then(get||util.getAndEncode).then(function(data){return util.dataAsUrl(data,util.mimeType(element.src))}).then(function(dataUrl){return new Promise(function(resolve,reject){element.onload=resolve,element.onerror=reject,element.src=dataUrl})})}}}var defaultOptions={imagePlaceholder:void 0,cacheBust:!(URL_REGEX=/url\(['"]?([^'"]+?)['"]?\)/g)},domtoimage={toSvg:toSvg,toPng:function(node,options){return draw(node,options||{}).then(function(canvas){return canvas.toDataURL()})},toJpeg:function(node,options){return draw(node,options=options||{}).then(function(canvas){return canvas.toDataURL("image/jpeg",options.quality||1)})},toBlob:function(node,options){return draw(node,options||{}).then(util.canvasToBlob)},toPixelData:function(node,options){return draw(node,options||{}).then(function(canvas){return canvas.getContext("2d").getImageData(0,0,util.width(node),util.height(node)).data})},impl:{fontFaces:fontFaces,images:images,util:util,inliner:inliner,options:{}}};function toSvg(node,options){return function(options){void 0===options.imagePlaceholder?domtoimage.impl.options.imagePlaceholder=defaultOptions.imagePlaceholder:domtoimage.impl.options.imagePlaceholder=options.imagePlaceholder,void 0===options.cacheBust?domtoimage.impl.options.cacheBust=defaultOptions.cacheBust:domtoimage.impl.options.cacheBust=options.cacheBust}(options=options||{}),Promise.resolve(node).then(function(node){return function cloneNode(node,filter,root){try{for(var nodeStyleTemp=window.getComputedStyle(node),i=0;i<nodeStyleTemp.length;i++){var key=nodeStyleTemp[i],value=nodeStyleTemp.getPropertyValue(key);if("display"===key&&"none"===value)return Promise.resolve()}}catch(error){}if(!root&&filter&&!filter(node))return Promise.resolve();return Promise.resolve(node).then(makeNodeCopy).then(function(clone){return cloneChildren(node,clone,filter)}).then(function(clone){return processClone(node,clone)});function makeNodeCopy(node){return node instanceof HTMLCanvasElement?util.makeImage(node.toDataURL()):node.cloneNode(!1)}function cloneChildren(children,clone,filter){var children=children.childNodes;return 0===children.length?Promise.resolve(clone):cloneChildrenInOrder(clone,util.asArray(children),filter).then(function(){return clone});function cloneChildrenInOrder(parent,children,filter){var done=Promise.resolve();return children.forEach(function(child){done=done.then(function(){return cloneNode(child,filter)}).then(function(childClone){childClone&&parent.appendChild(childClone)})}),done}}function processClone(original,clone){return clone instanceof Element?Promise.resolve().then(cloneStyle).then(clonePseudoElements).then(copyUserInput).then(fixSvg).then(function(){return clone}):clone;function cloneStyle(){function copyStyle(source,target){function copyProperties(source,target){util.asArray(source).forEach(function(name){target.setProperty(name,source.getPropertyValue(name),source.getPropertyPriority(name))})}source.cssText?target.cssText=source.cssText:copyProperties(source,target)}copyStyle(window.getComputedStyle(original),clone.style)}function clonePseudoElements(){function clonePseudoElement(element){var className,style=window.getComputedStyle(original,element),styleElement=style.getPropertyValue("content");function formatPseudoElementStyle(className,selector,cssText){var selector="."+className+":"+selector,cssText=(cssText.cssText?formatCssText:formatCssProperties)(cssText);return document.createTextNode(selector+"{"+cssText+"}");function formatCssText(style){var content=style.getPropertyValue("content");return style.cssText+" content: "+content+";"}function formatCssProperties(style){return util.asArray(style).map(formatProperty).join("; ")+";";function formatProperty(name){return name+": "+style.getPropertyValue(name)+(style.getPropertyPriority(name)?" !important":"")}}}""!==styleElement&&"none"!==styleElement&&(className=util.uid(),clone.className=clone.className+" "+className,(styleElement=document.createElement("style")).appendChild(formatPseudoElementStyle(className,element,style)),clone.appendChild(styleElement))}[":before",":after"].forEach(function(element){clonePseudoElement(element)})}function copyUserInput(){original instanceof HTMLTextAreaElement&&(clone.innerHTML=original.value),original instanceof HTMLInputElement&&clone.setAttribute("value",original.value)}function fixSvg(){clone instanceof SVGElement&&(clone.setAttribute("xmlns","http://www.w3.org/2000/svg"),clone instanceof SVGRectElement&&["width","height"].forEach(function(attribute){var value=clone.getAttribute(attribute);value&&clone.style.setProperty(attribute,value)}))}}}(node,options.filter,!0)}).then(inlineImages).then(function(clone){options.bgcolor&&(clone.style.backgroundColor=options.bgcolor);options.width&&(clone.style.width=options.width+"px");options.height&&(clone.style.height=options.height+"px");options.style&&Object.keys(options.style).forEach(function(property){clone.style[property]=options.style[property]});return clone}).then(function(clone){return function(node,width,height){return Promise.resolve(node).then(function(node){return node.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),(new XMLSerializer).serializeToString(node)}).then(util.escapeXhtml).then(function(xhtml){return'<foreignObject x="0" y="0" width="100%" height="100%">'+xhtml+"</foreignObject>"}).then(function(foreignObject){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+width+'" height="'+height+'">'+foreignObject+"</svg>"}).then(function(svg){return"data:image/svg+xml;charset=utf-8,"+svg})}(clone,options.width||util.width(node),options.height||util.height(node))})}function draw(domNode,options){return toSvg(domNode,options).then(util.makeImage).then(util.delay(100)).then(function(image){var canvas=function(ctx){var canvas=document.createElement("canvas");canvas.width=options.width||util.width(ctx),canvas.height=options.height||util.height(ctx),options.bgcolor&&((ctx=canvas.getContext("2d")).fillStyle=options.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height));return canvas}(domNode);return canvas.getContext("2d").drawImage(image,0,0),canvas})}function inlineImages(node){return images.inlineAll(node).then(function(){return node})}"undefined"!=typeof module?module.exports=domtoimage:global.domtoimage=domtoimage}(this);